name: GitOps Manifest Validation

on:
  pull_request:
    branches: [main, prod]
    paths: ['k8s-manifests/**']
  push:
    branches: [main,prod]
    paths: ['k8s-manifests/**']

jobs:
  validate-manifests:
    runs-on: ubuntu-latest
    steps:
    
    - name: Checkout code
      uses: actions/checkout@v4

    # Test 1: YAML Syntax Validation
    - name: ğŸ” YAML Lint Check
      run: |
        echo "Checking YAML syntax with yamllint..."
        pip install yamllint
        yamllint -d "{extends: default, rules: {document-start: disable}}" k8s-manifests
        echo "âœ… YAML lint passed!"

    # Test 2: Kubernetes Schema Validation
    - name: ğŸ›¡ï¸ Kubernetes Schema Validation
      uses: azure/setup-kubectl@v3
      
    - name: Validate K8s Manifests
      run: |
        echo "Validating Kubernetes manifests..."
        kubectl apply --dry-run=client --validate=true -f k8s-manifests/deployments/ || exit 1
        kubectl apply --dry-run=client --validate=true -f k8s-manifests/configmaps/ || exit 1
        kubectl apply --dry-run=client --validate=true -f k8s-manifests/ingress/ || exit 1
        kubectl apply --dry-run=client --validate=true -f k8s-manifests/secrets/ || exit 1
        kubectl apply --dry-run=client --validate=true -f k8s-manifests/autoscaling/ || exit 1
        echo "âœ… All manifests are valid!"

    # Test 3: Resource Requirements Check
    - name: ğŸ”§ Resource Requirements Check
      run: |
        echo "Checking resource requirements..."
        
        # Check if deployments have resource limits
        for file in k8s-manifests/deployments/*.yaml; do
          echo "Checking resource limits in: $file"
          
          if ! grep -q "resources:" "$file"; then
            echo "âŒ Missing resource limits in $file"
            exit 1
          fi
          
          if ! grep -q "limits:" "$file"; then
            echo "âŒ Missing resource limits in $file"
            exit 1
          fi
          
          if ! grep -q "requests:" "$file"; then
            echo "âŒ Missing resource requests in $file" 
            exit 1
          fi
        done
        echo "âœ… All deployments have resource limits!"

    # Test 4: Service-Deployment Matching
    # This extarcts the app labels from the deployments and checks if the services match them
    - name: ğŸ”— Service-Deployment Matching
      run: |
        echo "Checking service-deployment matching..."
        
        # Extract app labels from deployments
        BACKEND_LABEL=$(grep -A 10 "selector:" k8s-manifests/deployments/backend.yaml | grep "app:" | awk '{print $2}')
        FRONTEND_LABEL=$(grep -A 10 "selector:" k8s-manifests/deployments/frontend.yaml | grep "app:" | awk '{print $2}')
        
        # Check if services match
        if ! grep -q "app: $BACKEND_LABEL" k8s-manifests/deployments/backend.yaml; then
          echo "âŒ Backend service selector doesn't match deployment"
          exit 1
        fi
        
        if ! grep -q "app: $FRONTEND_LABEL" k8s-manifests/deployments/frontend.yaml; then
          echo "âŒ Frontend service selector doesn't match deployment"
          exit 1
        fi
        
        echo "âœ… Services match deployments!"

    # Test 5: Secret Reference Validation
    - name: ğŸ” Secret Reference Check
      run: |
        echo "Checking secret references..."
        
        # Check if referenced secrets exist in secret provider
        REQUIRED_SECRETS=("MONGODB_URI" "JWT_SECRET" "RAZORPAY_KEY_ID" "RAZORPAY_KEY_SECRET" "VITE_RAZORPAY_KEY")
        
        for secret in "${REQUIRED_SECRETS[@]}"; do
          if ! grep -q "$secret" k8s-manifests/secrets/secret-provider.yaml; then
            echo "âŒ Secret $secret not found in secret provider"
            exit 1
          fi
        done
        
        echo "âœ… All required secrets are configured!"

    # Test 6: Ingress Path Validation
    - name: ğŸŒ Ingress Configuration Check
      run: |
        echo "Checking ingress configuration..."
        
        # Check required paths exist
        if ! grep -q "/api" k8s-manifests/ingress/ingress.yaml; then
          echo "âŒ API path missing in ingress"
          exit 1
        fi
        
        if ! grep -q "/socket.io" k8s-manifests/ingress/ingress.yaml; then
          echo "âŒ Socket.IO path missing in ingress"
          exit 1
        fi
        
        if ! grep -q "backend-service" k8s-manifests/ingress/ingress.yaml; then
          echo "âŒ Backend service not referenced in ingress"
          exit 1
        fi
        
        if ! grep -q "frontend-service" k8s-manifests/ingress/ingress.yaml; then
          echo "âŒ Frontend service not referenced in ingress"
          exit 1
        fi
        
        echo "âœ… Ingress configuration is valid!"

    # Test 7: HPA Target Validation
    - name: ğŸ“Š HPA Configuration Check
      run: |
        echo "Checking HPA configuration..."
        
        # Check if HPA targets exist
        if ! grep -q "name: frontend" k8s-manifests/autoscaling/hpa-combined.yaml; then
          echo "âŒ Frontend HPA target missing"
          exit 1
        fi
        
        if ! grep -q "name: backend" k8s-manifests/autoscaling/hpa-combined.yaml; then
          echo "âŒ Backend HPA target missing"
          exit 1
        fi
        
        echo "âœ… HPA configuration is valid!"

    - name: âœ… All Tests Passed
      run: |
        echo "ğŸ‰ All GitOps validation tests passed!"
        echo "Your manifests are ready for deployment!"
